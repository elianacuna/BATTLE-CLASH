<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BattleClash</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/usuario.css">
</head>
<body>

    <header class="text-center py-3">
        <h1>Gestionar Usuarios</h1>
    </header>

    <div class="container mt-4">
        <form id="searchForm" class="d-flex justify-content-center mb-4">
            <div class="form-group me-3">
                <input type="text" id="criterio" class="form-control" placeholder="Buscar por Username o Ranking">
            </div>

            <div class="form-group me-3">
                <select id="rol" class="form-control">
                    <option value="">Seleccione un rol</option>
                    <option value="Admin">Admin</option>
                    <option value="Jugador">Jugador</option>
                    <option value="Bloqueado">Bloqueado</option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary">Buscar</button>
        </form>

        <table class="table table-bordered table-striped table-hover">
            <thead class="thead-light">
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Ranking</th>
                    <th>Rol</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="userTable">

            </tbody>
        </table>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Editar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label for="editUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="editUsername">
                        </div>
                        <div class="mb-3">
                            <label for="editRanking" class="form-label">Ranking</label>
                            <input type="number" class="form-control" id="editRanking">
                        </div>
                        <div class="mb-3">
                            <label for="editRol" class="form-label">Rol</label>
                            <select id="editRol" class="form-control">
                                <option value="Admin">Admin</option>
                                <option value="Jugador">Jugador</option>
                                <option value="Bloqueado">Bloqueado</option>
                                <option value="Bloqueado">SQA</option>

                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Guardar cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function cargarUsuarios(criterio = '', rol = '') {
            $.ajax({
                url: '../../modules/apis/usuario.php?action=listar',
                method: 'GET',
                data: {
                    criterio: criterio,
                    rol: rol
                },
                success: function(response) {
                    if (response.status === 'success') {
                        $('#userTable').empty();
                        response.data.forEach(function(user) {
                            $('#userTable').append(`
                                <tr>
                                    <td>${user.ID}</td>
                                    <td>${user.Username}</td>
                                    <td>${user.ranking}</td>
                                    <td>${user.rol}</td>
                                    <td>
                                        <button class="btn btn-warning btn-sm edit-btn" data-id="${user.ID}" data-username="${user.Username}" data-ranking="${user.ranking}" data-rol="${user.rol}">
                                            <i class="bi bi-pencil-fill"></i> Editar
                                        </button>
                                    </td>
                                </tr>
                            `);
                        });

                        $('.edit-btn').on('click', function() {
                            var userId = $(this).data('id');
                            var username = $(this).data('username');
                            var ranking = $(this).data('ranking');
                            var rol = $(this).data('rol');

                            $('#editUserId').val(userId);
                            $('#editUsername').val(username);
                            $('#editRanking').val(ranking);
                            $('#editRol').val(rol);

                            $('#editModal').modal('show');
                        });

                    } else {
                        $('#userTable').html('<tr><td colspan="5" class="text-center">No se encontraron usuarios</td></tr>');
                    }
                },
                error: function(error) {
                    console.log(error);
                    $('#userTable').html('<tr><td colspan="5" class="text-center text-danger">Error al buscar usuarios</td></tr>');
                }
            });
        }

        $(document).ready(function() {
            cargarUsuarios();  
        });

        $('#searchForm').on('submit', function(e) {
            e.preventDefault();

            var criterio = $('#criterio').val();
            var rol = $('#rol').val();

            cargarUsuarios(criterio, rol); 
        });

        $('#editForm').on('submit', function(e) {
            e.preventDefault();

            var userId = $('#editUserId').val();
            var username = $('#editUsername').val();
            var ranking = $('#editRanking').val();
            var rol = $('#editRol').val();

            $('#editModal').modal('hide');
        });
    </script>
</body>
</html>
